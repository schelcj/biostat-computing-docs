<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Biostatistics Cluster SLURM Scheduler/Resource Manager</title>
	<link type="text/css" rel="stylesheet" href="/css/sph.css"/>
	<link type="text/css" rel="stylesheet" href="/biostat/css/stylesheet.css"/>
	<link type="text/css" rel="stylesheet" href="/biostat/computing/overrides.css"/>
<link rel="stylesheet" type="text/css" href="/css/print.css" media="print" />
<link rel="stylesheet" type="text/css" href="/css/mobile.css" media="handheld" />
	<meta name="breadcrumb" content="sph|biostat|computing|cluster"/>
</head>
<body>
<!--#include virtual="/biostat/computing/header.shtml" -->

<h1 id="slurm">SLURM</h1>

<p>We are using <a href="https://computing.llnl.gov/linux/slurm/">SLURM (Simple Linux Utility for Resource Management)</a> for our resource manager
and job scheduler. Below are several of the basic commands you will need to interact with the cluster.</p>

<p>The commands for launching jobs in the cluster are <a href="#sbatch">sbatch</a>, <a href="#srun">srun</a> and <a href="#salloc">salloc</a>. The preferred
and primary means of launching jobs in the cluster is with <a href="#sbatch">sbatch</a>.</p>

<blockquote>
<p>In a nutshell, sbatch and salloc allocate resources to the job, while srun launches parallel tasks across those resources.
When invoked within a job allocation, srun will launch parallel tasks across some or all of the allocated resources.
In that case, srun inherits by default the pertinent options of the sbatch or salloc which it runs under. You can then
(usually) provide srun different options which will override what it receives by default. Each invocation of srun within
a job is known as a job step. </p>

<p>srun can also be invoked outside of a job allocation. In that case, srun requests resources,
and when those resources are granted, launches tasks across those resources as a single job and job step. </p>
</blockquote>

<p><em>Source: <a href="http://groups.google.com/group/slurm-devel/msg/b8c9a2f51ce334a1">slurm-devel mailing list post</a></em></p>

<h2 id="commands">Commands</h2>

<ol>
<li><a href="#sbatch">sbatch</a></li>
<li><a href="#sarray">sarray</a></li>
<li><a href="#squeue">squeue</a></li>
<li><a href="#scancel">scancel</a></li>
<li><a href="#srun">srun</a></li>
<li><a href="#salloc">salloc</a></li>
</ol>

<h3 id="sbatch"><a href="#sbatch">sbatch</a></h3>

<p>sbatch submits a batch script to SLURM. The batch script may be givento sbatch through a file name
on the command line, or if no file name is specified, sbatch will read in a script from standard
input. The batch script may contain options preceded with <strong>#SBATCH</strong> before any executable commands
in the script.</p>

<p>sbatch exits immediately after the script is successfully transferred to the SLURM controller
and assigned a SLURM job ID. The batch script is not necessarily granted resources immediately,
it may sit in the queue of pending jobs for some time before its required resources become available.</p>

<p>When the job allocation is finally granted for the batch script, SLURM runs a single copy of
the batch script on the first node in the set of allocated nodes.</p>

<pre><code>$ cat sample.txt 
#!/bin/sh

#SBATCH --mail-type=ALL
#SBATCH --mail-user=@umich.edu
#SBATCH --ntasks=5
#SBATCH --job-name=test

R CMD BATCH script.R

$ sbatch ./sample.txt
Submitted batch job 25618

$ cat slurm-25618.out
# any output to STDOUT would be in this file
</code></pre>

<h3 id="sarray"><a href="#sarray">sarray</a></h3>

<p>This script allows you to run multiple jobs from a single batch script with the only difference
in each job being the array index. The array index gives the script a means of changing parameters,
loading differing data files or anything that requires a unique index.</p>

<p>This script only accepts an batch script suitable for sbatch. The batch script must include the comment
marker to indicate the range of array indexes. The comment is similiar to sbatch comments that must start
in column zero of the script. The value can be a range separated by a dash <em>( -)</em>, a comma separated list
of index numbers or both.</p>

<pre><code>#SARRAY --range=1-20

#SARRAY --range=1-10,12,14,16-20
</code></pre>

<p>This would create jobs with the id appended to the end of your defined job name with the id within
brackets such as; <em>jobname[1], jobname[2] &#8230; jobname[20]</em>.</p>

<p>The array index is passed back to the batch script as the environment variable <strong>$SLURM_ARRAYID</strong> for
each iteration through the index(es) you provided via the <em>&#8211;range</em> option.</p>

<h4 id="usage">Usage</h4>

<pre><code>$ sarray ./job.txt
$ sarray -J ./job.txt
</code></pre>

<p><em><strong>-J</strong> Will maintain the jobname you specified and not attempt to append the array id</em></p>

<h4 id="examples">Examples</h4>

<pre><code>$ cat array_job.txt
#!/bin/sh

#SBATCH --mail-type=ALL
#SBATCH --mail-user=uniqname@umich.edu
#SBATCH --time=1-0
#SBATCH --job-name=array_job_test

#SARRAY --range=1-10

srun R CMD BATCH script-${SLURM_ARRAYID}.R

$ sarray ./array_job.txt
Submitted batch job 12345
Submitted batch job 12346
Submitted batch job 12347
Submitted batch job 12348
Submitted batch job 12349
Submitted batch job 12350
Submitted batch job 12351
Submitted batch job 12352
Submitted batch job 12353
Submitted batch job 12354
$
</code></pre>

<h3 id="squeue"><a href="#squeue">squeue</a></h3>

<p>This command is used to view information about the slurm scheduling queue.</p>

<p>To view you jobs in the queue regardless of their current state.</p>

<pre><code>$ squeue -u $USER
</code></pre>

<h4 id="jobstatuscodes">Job Status Codes</h4>

<p>Typically your job will be either in the Running state of PenDing state.
However here is a breakdown of all the states that your job could be in.</p>

<table>
<colgroup>
<col style="text-align:left;"/>
<col style="text-align:left;"/>
<col style="text-align:left;"/>
</colgroup>

<thead>
<tr>
	<th style="text-align:left;">Code</th>
	<th style="text-align:left;">State</th>
	<th style="text-align:left;">Description</th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;">CA</td>
	<td style="text-align:left;">CANCELLED</td>
	<td style="text-align:left;">Job was explicitly cancelled by the user or system administrator. The job may or may not have been initiated.</td>
</tr>
<tr>
	<td style="text-align:left;">CD</td>
	<td style="text-align:left;">COMPLETED</td>
	<td style="text-align:left;">Job has terminated all processes on all nodes.</td>
</tr>
<tr>
	<td style="text-align:left;">CF</td>
	<td style="text-align:left;">CONFIGURING</td>
	<td style="text-align:left;">Job has been allocated resources, but are waiting for them to become ready for use (e.g. booting).</td>
</tr>
<tr>
	<td style="text-align:left;">CG</td>
	<td style="text-align:left;">COMPLETING</td>
	<td style="text-align:left;">Job is in the process of completing. Some processes on some nodes may still be active.</td>
</tr>
<tr>
	<td style="text-align:left;">F</td>
	<td style="text-align:left;">FAILED</td>
	<td style="text-align:left;">Job terminated with non-zero exit code or other failure condition.</td>
</tr>
<tr>
	<td style="text-align:left;">NF</td>
	<td style="text-align:left;">NODE_FAIL</td>
	<td style="text-align:left;">Job terminated due to failure of one or more allocated nodes.</td>
</tr>
<tr>
	<td style="text-align:left;">PD</td>
	<td style="text-align:left;">PENDING</td>
	<td style="text-align:left;">Job is awaiting resource allocation.</td>
</tr>
<tr>
	<td style="text-align:left;">R</td>
	<td style="text-align:left;">RUNNING</td>
	<td style="text-align:left;">Job currently has an allocation.</td>
</tr>
<tr>
	<td style="text-align:left;">S</td>
	<td style="text-align:left;">SUSPENDED</td>
	<td style="text-align:left;">Job has an allocation, but execution has been suspended.</td>
</tr>
<tr>
	<td style="text-align:left;">TO</td>
	<td style="text-align:left;">TIMEOUT</td>
	<td style="text-align:left;">Job terminated upon reaching its time limit.</td>
</tr>
</tbody>
</table>
<h3 id="scancel"><a href="#scancel">scancel</a></h3>

<p>Used to signal jobs or job steps that are under the control of Slurm.</p>

<p>scancel is used to signal or cancel jobs or job steps. An arbitrary number
of jobs or job steps may be signaled using job specification filters or a
space separated list of specific job and/or job step IDs. A job or job step
can only be signaled by the owner of that job or user root. If an attempt is
made by an unauthorized user to signal a job or job step, an error message
will be printed and the job will not be signaled.</p>

<pre><code>$ squeue 
JOBID PARTITION     NAME     USER  ST       TIME  NODES NODELIST(REASON)
29908 biostat-d     bash  schelcj   R       0:05      2 cn[001-002]
$ scancel 29908
$ squeue
JOBID PARTITION     NAME     USER  ST       TIME  NODES NODELIST(REASON)
$
</code></pre>

<p>Here we see our jobid is 29908 then we cancel that job with the scancel command.</p>

<h3 id="srun"><a href="#srun">srun</a></h3>

<p>Used to launch a jobs in the cluster</p>

<p>The following example runs the /bin/hostname command on at least
two nodes in the cluster. STDOUT/STDERR return to your terminal.</p>

<pre><code>$ srun --nodes=2 hostname
cn001
cn002
</code></pre>

<p>You can specify the number of cpu&#8217;s to use per job with the <em>&#8211;cpus-per-task</em> option.</p>

<pre><code>$ srun --nodes=2 --cpus-per-task=3 R CMD BATCH script.R
</code></pre>

<p>All SAS jobs should be run in the biostat-sas partition to meet license restrictions.</p>

<pre><code>$ srun --partition=biostat-sas some_sas_script.sas
</code></pre>

<p>Provided there are available licenses the job will be launched according the the normal
allocation process. If the license pool has been exhausted then the job will remain in
the pending state until a license is freed for use.</p>

<h3 id="salloc"><a href="#salloc">salloc</a></h3>

<p>Obtain an interactive SLURM job allocation (a set of nodes), execute a
command, and then release the allocation when the command is finished.</p>

<p>This just requests an allocation of cluster resources and gives you an
interactive shell (when you exit that shell the allocation is relinquished
and all jobs running are cancelled.) For example</p>

<pre><code>$ salloc -N2
salloc: Granted job allocation 29903
$ srun hostname
cn002
cn001
$
</code></pre>

<p>Here we have requested two nodes be allocated then we run /bin/hostname to
see what nodes we were allocated. Any command we run within this allocation
is run in parallel across the number of nodes we requested, in this case 2.
So for instance if you had an R script that generated its own unique dataset for
each invocation you could have ran that script across two nodes. For example;</p>

<pre><code>$ salloc -N2
salloc: Grant job allocation 12345
$ srun R CMD BATCH script.R &amp;
$ srun R CMD BATCH script.R &amp;
$ srun R CMD BATCH script.R &amp;
$
</code></pre>

<p>In this example you have a two node allocation with each call to srun using a
single core on both machines. Each call to srun launches the same R script on
each node and the &amp; sign backgrounds the process so that you can issue more srun
commands. This example is now running the R script 6 times across two nodes.</p>

<pre><code>$ env|grep SLURM
SLURM_NODELIST=cn[001-002]
SLURM_NNODES=2
SLURM_JOBID=29903
SLURM_TASKS_PER_NODE=2(x2)
SLURM_JOB_ID=29903
SLURM_JOB_NODELIST=cn[001-002]
SLURM_JOB_CPUS_PER_NODE=2(x2)
SLURM_JOB_NUM_NODES=2
</code></pre>

<p>While within the interactive allocation you have several environmental varilables
available to you that describe the allocation. Having things like the JOB_ID available
make it possible to use the <em>&#8211;dependency</em> option to srun.</p>

<!--#include virtual="/biostat/computing/footer.shtml" -->
</body>
</html>
